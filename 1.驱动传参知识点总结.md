# Linux内核驱动传参知识点总结

## 1. 参数声明宏

### 1.1 单个整型参数
```c
static int a = 11;
module_param(a, int, S_IRUGO);
MODULE_PARM_DESC(a, "qudong chuancan int");
```

- `module_param(name, type, perm)`: 声明一个模块参数
  - `name`: 参数名（在驱动代码中使用）
  - `type`: 参数类型（int, uint, long, ulong, charp, bool等）
  - `perm`: 权限掩码，控制参数的可读性和权限

### 1.2 数组参数
```c
static int array[5] = {2};
static int array_size;
module_param_array(array, int, &array_size, S_IRUGO);
MODULE_PARM_DESC(array, "shuzu");
```

- `module_param_array(name, type, nump, perm)`: 声明数组参数
  - `nump`: 指向整数的指针，用于记录实际传入的元素个数
  - 必须定义额外的变量来存储数组大小

### 1.3 字符串参数
```c
static char string[11] = "hello zmor";
module_param_string(name, string, sizeof(string), S_IRUGO);
MODULE_PARM_DESC(string, "zifuchuan");
```

- `module_param_string(name, string, len, perm)`: 声明字符串参数
  - `len`: 字符串缓冲区大小

## 2. 权限掩码

常用权限常量：
- `S_IRUGO`: 所有用户只读 (0444)
- `S_IRUGO|S_IWUSR`: 所有者可写，其他用户只读 (0644)
- `S_IRWXU`: 所有者可读写执行 (0700)

这些权限控制在`/sys/module/模块名/parameters/`目录下的参数文件权限。

## 3. 参数如何传

```bash
# 加载模块时传递参数
insmod param.ko a=100 array=1,2,3,4,5 string="zmor_test"
```

## 4. 编译配置文件Makefile

### 4.1 ARM64版本
```makefile
export ARCH=arm64
export CROSS_COMPILE=/home/zmor/Linux/rk3568_linux_5.10/prebuilts/gcc/linux-x86/aarch64/...
KDIR := /home/zmor/Linux/rk3568_linux_5.10/kernel
```

### 4.2 x86版本
```makefile
# 针对x86架构编译
export ARCH=x86
# 使用系统默认编译器
# 不设置CROSS_COMPILE，使用gcc
```

## 5. 项目文件结构分析

```
param/
├── param.c          # 驱动源码文件
├── Makefile         # ARM64编译配置
├── Makefilex86      # x86编译配置
├── build/           # ARM64编译输出目录
└── build_x86/       # x86编译输出目录
```

## 6. 编译和测试

### 编译ARM64版本
```bash
make
```

### 编译x86版本
```bash
make -f Makefilex86
```

### 测试参数传递
```bash
# 加载模块时传递参数
sudo insmod build/param.ko a=200 array=10,20,30 string="hello world"

# 查看模块参数
cat /sys/module/param/parameters/a
cat /sys/module/param/parameters/array
cat /sys/module/param/parameters/string

# 查看内核日志最后10行
dmesg | tail -n 10

# 卸载模块
sudo rmmod param
```
