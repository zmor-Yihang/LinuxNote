# Linux内核头文件分类速查手册

## 一、模块与内核基础

### 模块开发必备
```c
#include <linux/module.h>       // 模块声明: MODULE_LICENSE, MODULE_AUTHOR, MODULE_DESCRIPTION
#include <linux/kernel.h>       // 内核工具: printk, container_of, ARRAY_SIZE
#include <linux/init.h>         // 初始化宏: __init, __exit, module_init, module_exit
#include <linux/moduleparam.h>  // 模块参数: module_param, MODULE_PARM_DESC
```

### 基本类型与宏
```c
#include <linux/types.h>        // 基本类型: u8, u16, u32, u64, size_t, bool
#include <linux/stddef.h>       // 标准定义: NULL, offsetof
#include <linux/errno.h>        // 错误码: ENOMEM, EFAULT, EINVAL, EBUSY
#include <linux/err.h>          // 错误指针: IS_ERR, PTR_ERR, ERR_PTR
#include <linux/const.h>        // 常量定义
#include <linux/limits.h>       // 各种限制值
#include <linux/build_bug.h>    // 编译时断言
```

### 内核工具函数
```c
#include <linux/string.h>       // 字符串: memcpy, memset, strcmp, strlen
#include <linux/bitmap.h>       // 位图操作
#include <linux/bitops.h>       // 位操作: set_bit, clear_bit, test_bit
#include <linux/bits.h>         // 位相关宏: BIT, GENMASK
#include <linux/math64.h>       // 64位数学运算
#include <linux/log2.h>         // 对数运算
#include <linux/printk.h>       // 打印: printk, pr_info, pr_err, pr_debug
```

---

## 二、字符设备驱动

### 字符设备核心
```c
#include <linux/fs.h>           // 文件操作: file_operations, inode, file
#include <linux/cdev.h>         // 字符设备: cdev, cdev_init, cdev_add, cdev_del
#include <linux/device.h>       // 设备模型: class_create, device_create
#include <linux/kdev_t.h>       // 设备号: MAJOR, MINOR, MKDEV
#include <linux/miscdevice.h>   // 杂项设备: misc_register, misc_deregister
```

### 文件操作相关
```c
#include <linux/file.h>         // 文件描述符操作
#include <linux/fcntl.h>        // 文件控制: O_RDONLY, O_WRONLY, O_RDWR
#include <linux/poll.h>         // poll/select: poll_table, poll_wait
#include <linux/splice.h>       // splice 操作
#include <linux/aio.h>          // 异步I/O
```

### 用户空间交互
```c
#include <linux/uaccess.h>      // 用户空间访问: copy_to_user, copy_from_user, get_user, put_user
#include <linux/ioctl.h>        // ioctl 命令: _IO, _IOR, _IOW, _IOWR
#include <linux/compat.h>       // 32/64位兼容
```

---

## 三、内存管理

### 内存分配
```c
#include <linux/slab.h>         // 堆内存: kmalloc, kzalloc, kfree, kmem_cache_*
#include <linux/slub_def.h>     // SLUB 分配器
#include <linux/slab_def.h>     // SLAB 分配器
#include <linux/vmalloc.h>      // 虚拟内存: vmalloc, vfree, vmap
#include <linux/gfp.h>          // 页分配: __get_free_pages, free_pages, GFP_KERNEL, GFP_ATOMIC
#include <linux/mm.h>           // 内存管理核心
#include <linux/mmzone.h>       // 内存区域管理
```

### 内存映射与页操作
```c
#include <linux/highmem.h>      // 高端内存: kmap, kunmap
#include <linux/page-flags.h>   // 页标志
#include <linux/pagemap.h>      // 页缓存
#include <linux/mman.h>         // mmap 相关: PROT_*, MAP_*
#include <linux/mempolicy.h>    // NUMA 内存策略
#include <linux/memblock.h>     // 早期内存分配
#include <linux/mempool.h>      // 内存池
```

### DMA 内存
```c
#include <linux/dma-mapping.h>  // DMA 映射: dma_alloc_coherent, dma_map_single
#include <linux/dma-direct.h>   // 直接 DMA 映射
#include <linux/dmaengine.h>    // DMA 引擎
#include <linux/dmapool.h>      // DMA 内存池
#include <linux/dma-buf.h>      // DMA buffer 共享
```

---

## 四、同步与锁机制

### 互斥锁
```c
#include <linux/mutex.h>        // 互斥锁: mutex, mutex_init, mutex_lock, mutex_unlock
#include <linux/semaphore.h>    // 信号量: semaphore, down, up
```

### 自旋锁
```c
#include <linux/spinlock.h>     // 自旋锁: spinlock_t, spin_lock, spin_unlock
#include <linux/spinlock_types.h> // 自旋锁类型定义
#include <linux/rwlock.h>       // 读写锁
#include <linux/seqlock.h>      // 顺序锁
```

### RCU 与原子操作
```c
#include <linux/rcupdate.h>     // RCU: rcu_read_lock, rcu_read_unlock, synchronize_rcu
#include <linux/rculist.h>      // RCU 链表
#include <linux/atomic.h>       // 原子操作: atomic_t, atomic_inc, atomic_dec
#include <linux/refcount.h>     // 引用计数
```

### 完成量与等待队列
```c
#include <linux/completion.h>   // 完成量: completion, wait_for_completion, complete
#include <linux/wait.h>         // 等待队列: wait_queue_head_t, wait_event, wake_up
#include <linux/rwsem.h>        // 读写信号量
```

---

## 五、中断与定时器

### 中断处理
```c
#include <linux/interrupt.h>    // 中断: request_irq, free_irq, disable_irq, enable_irq
#include <linux/irq.h>          // 中断描述符
#include <linux/irqdesc.h>      // 中断描述符详细信息
#include <linux/irqdomain.h>    // 中断域
#include <linux/irqreturn.h>    // 中断返回值: IRQ_HANDLED, IRQ_NONE
#include <linux/irqflags.h>     // 中断标志: local_irq_save, local_irq_restore
#include <linux/hardirq.h>      // 硬中断上下文判断: in_irq, in_interrupt
#include <linux/softirq.h>      // 软中断
```

### 定时器与延时
```c
#include <linux/timer.h>        // 定时器: timer_list, add_timer, del_timer
#include <linux/hrtimer.h>      // 高精度定时器
#include <linux/delay.h>        // 延时: udelay, mdelay, ndelay, msleep, usleep_range
#include <linux/jiffies.h>      // 节拍: jiffies, HZ, time_after, time_before
#include <linux/timekeeping.h>  // 时间获取: ktime_get
#include <linux/time.h>         // 时间结构
#include <linux/ktime.h>        // 内核时间类型
```

### 工作队列
```c
#include <linux/workqueue.h>    // 工作队列: work_struct, schedule_work, flush_work
#include <linux/kthread.h>      // 内核线程: kthread_create, kthread_run
```

---

## 六、I/O 与硬件访问

### I/O 端口与内存映射
```c
#include <linux/io.h>           // I/O 访问: ioremap, iounmap, readb, writeb, readl, writel
#include <linux/ioport.h>       // I/O 端口资源: request_region, request_mem_region
#include <linux/io-64-nonatomic-lo-hi.h> // 64位非原子I/O (低位优先)
#include <linux/io-64-nonatomic-hi-lo.h> // 64位非原子I/O (高位优先)
```

### 平台设备与设备树
```c
#include <linux/platform_device.h> // 平台设备驱动
#include <linux/of.h>           // 设备树: of_property_read_*, of_find_node_by_name
#include <linux/of_device.h>    // 设备树设备匹配
#include <linux/of_address.h>   // 设备树地址解析
#include <linux/of_irq.h>       // 设备树中断解析
#include <linux/of_gpio.h>      // 设备树 GPIO 解析
#include <linux/of_platform.h>  // 设备树平台设备
```

### GPIO 操作
```c
#include <linux/gpio.h>         // GPIO 旧接口: gpio_request, gpio_direction_input
#include <linux/gpio/consumer.h> // GPIO 新接口: gpiod_get, gpiod_set_value
#include <linux/gpio/driver.h>  // GPIO 驱动
```

---

## 七、总线与设备驱动

### PCI 设备
```c
#include <linux/pci.h>          // PCI 驱动: pci_register_driver, pci_enable_device
#include <linux/pci_ids.h>      // PCI 设备 ID
#include <linux/pcie/portdrv.h> // PCIe 端口驱动
```

### USB 设备
```c
#include <linux/usb.h>          // USB 驱动: usb_register, usb_submit_urb
#include <linux/usb/ch9.h>      // USB 规范定义
#include <linux/usb/gadget.h>   // USB gadget 驱动
```

### I2C 总线
```c
#include <linux/i2c.h>          // I2C 驱动: i2c_add_driver, i2c_transfer
#include <linux/i2c-dev.h>      // I2C 用户空间接口
```

### SPI 总线
```c
#include <linux/spi/spi.h>      // SPI 驱动: spi_register_driver, spi_sync
```

### 其他总线
```c
#include <linux/serio.h>        // Serio 总线 (键盘/鼠标)
#include <linux/input.h>        // 输入子系统
#include <linux/mtd/mtd.h>      // MTD (闪存) 设备
#include <linux/mmc/host.h>     // MMC/SD 卡
#include <linux/usb/serial.h>   // USB 串口
```

---

## 八、网络驱动

### 网络设备基础
```c
#include <linux/netdevice.h>    // 网络设备: net_device, netif_rx, register_netdev
#include <linux/etherdevice.h>  // 以太网设备: alloc_etherdev, eth_type_trans
#include <linux/skbuff.h>       // sk_buff: alloc_skb, dev_kfree_skb
#include <linux/if_ether.h>     // 以太网协议
#include <linux/ethtool.h>      // ethtool 接口
```

### 网络协议
```c
#include <linux/ip.h>           // IP 协议头
#include <linux/tcp.h>          // TCP 协议头
#include <linux/udp.h>          // UDP 协议头
#include <linux/icmp.h>         // ICMP 协议
#include <linux/if_vlan.h>      // VLAN
```

### Socket 与网络过滤
```c
#include <linux/socket.h>       // Socket 相关
#include <linux/net.h>          // 网络核心
#include <linux/netfilter.h>    // netfilter 框架
```

---

## 九、块设备驱动

### 块设备核心
```c
#include <linux/blkdev.h>       // 块设备: request_queue, gendisk, blk_mq_*
#include <linux/blk-mq.h>       // 多队列块设备
#include <linux/bio.h>          // 块 I/O: bio, submit_bio
#include <linux/buffer_head.h>  // 缓冲区头
#include <linux/genhd.h>        // 通用硬盘
```

### 文件系统相关
```c
#include <linux/fs.h>           // 文件系统通用接口
#include <linux/dcache.h>       // 目录项缓存
#include <linux/pagemap.h>      // 页缓存
#include <linux/writeback.h>    // 回写
```

---

## 十、进程与调度

### 进程管理
```c
#include <linux/sched.h>        // 进程调度: task_struct, current, schedule
#include <linux/sched/signal.h> // 进程信号
#include <linux/pid.h>          // 进程 ID
#include <linux/capability.h>   // 权限检查: capable
```

### 线程与任务
```c
#include <linux/kthread.h>      // 内核线程
#include <linux/smp.h>          // SMP 相关
#include <linux/cpu.h>          // CPU 热插拔
#include <linux/cpumask.h>      // CPU 掩码
```

---

## 十一、电源管理

```c
#include <linux/pm.h>           // 电源管理: pm_ops, suspend, resume
#include <linux/pm_runtime.h>   // 运行时电源管理
#include <linux/suspend.h>      // 挂起/恢复
#include <linux/reboot.h>       // 重启通知
```

---

## 十二、调试与诊断

### 调试工具
```c
#include <linux/debugfs.h>      // debugfs: debugfs_create_file
#include <linux/kgdb.h>         // 内核调试器
#include <linux/kprobes.h>      // 内核探测
#include <linux/tracepoint.h>   // 跟踪点
```

### 日志与追踪
```c
#include <linux/printk.h>       // 内核打印
#include <linux/dynamic_debug.h> // 动态调试
#include <linux/ftrace.h>       // 函数跟踪
```

### 性能分析
```c
#include <linux/perf_event.h>   // 性能事件
#include <linux/ring_buffer.h>  // 环形缓冲区
```

---

## 十三、数据结构

### 链表
```c
#include <linux/list.h>         // 双向链表: list_head, list_add, list_del, list_for_each
#include <linux/llist.h>        // 无锁链表
#include <linux/plist.h>        // 优先级链表
```

### 队列与栈
```c
#include <linux/kfifo.h>        // 先进先出队列
#include <linux/circ_buf.h>     // 环形缓冲区
```

### 树与哈希表
```c
#include <linux/rbtree.h>       // 红黑树: rb_root, rb_node
#include <linux/radix-tree.h>   // 基数树
#include <linux/xarray.h>       // XArray (替代 radix-tree)
#include <linux/hashtable.h>    // 哈希表
#include <linux/hash.h>         // 哈希函数
#include <linux/idr.h>          // ID 分配器
```

### 位图与位域
```c
#include <linux/bitmap.h>       // 位图操作
#include <linux/bitfield.h>     // 位域操作
```

---

## 十四、加密与安全

```c
#include <linux/crypto.h>       // 加密 API
#include <linux/random.h>       // 随机数: get_random_bytes
#include <linux/crc32.h>        // CRC32 校验
#include <linux/crc16.h>        // CRC16 校验
#include <linux/md5.h>          // MD5 哈希
```

---

## 十五、杂项功能

### 通知机制
```c
#include <linux/notifier.h>     // 通知链
#include <linux/kobject.h>      // 内核对象
#include <linux/sysfs.h>        // sysfs 文件系统
```

### proc 和 sysctl
```c
#include <linux/proc_fs.h>      // proc 文件系统
#include <linux/seq_file.h>     // 顺序文件接口
#include <linux/sysctl.h>       // sysctl 接口
```

### 其他
```c
#include <linux/ctype.h>        // 字符分类: isdigit, isalpha
#include <linux/parser.h>       // 参数解析
#include <linux/uuid.h>         // UUID 生成
#include <linux/sort.h>         // 排序算法
#include <linux/bsearch.h>      // 二分查找
```

---

## 十六、特定硬件平台

### ARM 相关
```c
#include <linux/arm-smccc.h>    // ARM SMC 调用
#include <linux/psci.h>         // PSCI (电源状态协调接口)
```

### Rockchip 平台
```c
#include <linux/rockchip/rockchip_ion.h>  // ION 内存管理
#include <linux/rockchip/rk-dma-heap.h>   // DMA heap
```

---

## 快速查询索引

### 按功能查找
- **字符设备**: `fs.h`, `cdev.h`, `device.h`
- **内存分配**: `slab.h`, `vmalloc.h`, `gfp.h`
- **用户交互**: `uaccess.h`, `ioctl.h`
- **锁机制**: `mutex.h`, `spinlock.h`, `semaphore.h`
- **中断**: `interrupt.h`, `irq.h`
- **定时器**: `timer.h`, `delay.h`, `jiffies.h`
- **I/O访问**: `io.h`, `ioport.h`
- **设备树**: `of.h`, `of_device.h`, `of_address.h`
- **工作队列**: `workqueue.h`, `kthread.h`
- **链表**: `list.h`
- **网络**: `netdevice.h`, `skbuff.h`, `etherdevice.h`

### 常见错误码 (errno.h)
```c
EPERM          1   // 操作不允许
ENOENT         2   // 文件或目录不存在
EINTR          4   // 系统调用被中断
EIO            5   // I/O 错误
ENXIO          6   // 设备或地址不存在
ENOMEM        12   // 内存不足
EACCES        13   // 权限不够
EFAULT        14   // 错误的地址
EBUSY         16   // 设备或资源忙
ENODEV        19   // 设备不存在
EINVAL        22   // 无效参数
ENOSPC        28   // 设备没有空间
EAGAIN        11   // 再试一次 (非阻塞模式)
ERESTARTSYS  512   // 重启系统调用
ETIMEDOUT    110   // 超时
```

---

## 使用建议

1. **分阶段包含**: 
   - 开发初期只包含必需的头文件
   - 编译报错时再添加缺失的头文件

2. **避免循环依赖**:
   - 头文件中使用前向声明而非包含完整头文件
   - 在 .c 文件中包含具体头文件

3. **头文件顺序**:
   ```c
   // 1. 标准C库头文件 (如果需要)
   // 2. Linux 内核通用头文件
   #include <linux/module.h>
   #include <linux/kernel.h>
   // 3. 特定功能头文件
   #include <linux/fs.h>
   #include <linux/cdev.h>
   // 4. 体系结构相关头文件
   #include <asm/io.h>
   // 5. 本地头文件
   #include "mydriver.h"
   ```

4. **保存模板**: 为常见驱动类型建立头文件模板

---

## 附录：特殊宏定义位置

```c
// 内核版本
LINUX_VERSION_CODE           // <linux/version.h>

// 模块信息
MODULE_LICENSE()             // <linux/module.h>
MODULE_AUTHOR()             // <linux/module.h>
MODULE_DESCRIPTION()        // <linux/module.h>

// 日志级别
KERN_EMERG, KERN_ERR...     // <linux/kern_levels.h>

// GFP 标志
GFP_KERNEL, GFP_ATOMIC      // <linux/gfp.h>

// ioctl 命令构造
_IO(), _IOR(), _IOW()       // <linux/ioctl.h>

// 容器获取
container_of()              // <linux/kernel.h>

// 编译优化
likely(), unlikely()        // <linux/compiler.h>
```